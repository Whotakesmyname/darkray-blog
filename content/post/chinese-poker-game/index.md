---
title: "“斗地主”的残局解算"
description: Refactoring of an old toy
date: 2021-06-27T02:18:26+08:00
image: title.jpg
tags: [ C++ ]
categories: [ Chinese, Programming ]
---

原本只是个初涉C++时练手的玩具，用来解*欢乐斗地主*的残局模式。能标榜自己性能最好，现在看多少有些“同行衬托”的意思。现在回头看，一些设计还是
> "Too young too simple, sometimes naive."

或许也是因为动机来自于现实需求，项目老而弥坚，断断续续总有访客。有的很直接给了我几个bad cases，有的问怎么编译，还有几个直接star的我想是没有耐心看code的。实在不忍心用自己都不想回顾的代码为难无辜的陌生人，拖拖拉拉地还是做了这次重构。

## 新设计
### 项目构建、依赖改进
首先，**构建系统切换到cmake**，方便跨平台做IDE无关的构建；以后再有编译不出来的就可以直接甩锅给cmake了。其次，**移除掉对Boost的依赖**；原先肮脏的补丁代码重写后，其实也不需要那个丑丑的`range_hash`。

### 项目结构的重新设计
对问题结构有更成熟的理解后，设计了更优的处理逻辑，对每一局牌型的处理都被分成三个阶段：
1. 预处理
2. 对抗搜索
3. 结果展现

，并且通过更合适的数据结构和对象管理方法减少资源的使用。

由于原版的设计文档没有迁移到新博客，并且整体基本是一次重写，所以会将项目再次完整地梳理一遍。

## 问题结构
斗地主残局是一种*完全信息博弈*，且显然没有平局。根据*策梅洛定理*其中一方必有必胜策略。从而我们将双方手牌作为一个状态，任意一方的出牌作为状态的一个转换，形成一颗决策树。在此决策树上实现*MinMax算法*，又或者称为*对抗搜索（Adversarial Search）*——即对我方行动回合最大化得分，对方行动回合最小化得分，整体做一次DFS。

## 问题性质
- **全局可出牌型有限**：双方的可能出牌在开局前就是已知的了，此后的所有状态中能出的牌一定是开局可出牌型的子集。进一步更强的有，每轮一方可出的牌型必是其在父节点可出牌型的子集。

## 优化方法
### 开局预处理
对应*全局可出牌型有限*的问题性质，考虑重写牌型对比部分逻辑。在开局做一次预处理，将牌型视为顶点，大小关系视为一条有向边，构建一个全局的有向无环图并做缓存，以供后续搜索使用。该缓存在*预处理*阶段被生成，*对抗搜索*阶段被使用，搜索完成后即可被析构。

此处需要解决的问题有：
- 牌型和牌型间需要*Partial Ordering*，即存在相等、大于、小于、不可比四种情况。C++20的*spaceship operator*帮助解决了这个问题。
- 每一轮出牌后需要检查剩余手牌的可出牌型，即排除掉父节点的不可用牌型。该检查本质上是检查手牌是否有足够的某牌型所需要的牌。如何高效地完成这个检查，又或者能否从出掉的牌中得到一些信息帮助更高效地完成检查。
- 检查任意手牌中可出的所有牌型。一个繁琐也不失技巧的工作。